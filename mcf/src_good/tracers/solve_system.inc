  ! This looks messy, but it is fast.
  IF (num_dim == 2) THEN

     a(1,1) = r0 
     a(1,2) = -r1(1)
     a(1,3) = -r1(2) 
     a(2,1) = r1(1) 
     a(2,2) = -r2(1,1)
     a(2,3) = -r2(2,1)
     a(3,1) = r1(2) 
     a(3,2) = -r2(1,2)
     a(3,3) = -r2(2,2)


     denom = &
          a(1,1) * a(2,2) * a(3,3) - &
          a(1,1) * a(2,3) * a(3,2) - &
          a(1,2) * a(2,1) * a(3,3) + &
          a(1,2) * a(2,3) * a(3,1) + &
          a(1,3) * a(2,1) * a(3,2) - &
          a(1,3) * a(2,2) * a(3,1)



     DO it = 1, num_dim

        f(1) = f0(it)
        f(2) = f1(it, 1)
        f(3) = f1(it, 2) 


        ! solves to find the first unknown of a system of linear equations of size 3.

        ! [aij] * [xj] = [fi]

        !       a12 a23 f3 - a12 a33 f2 - a13 a22 f3 + a13 a32 f2 + a22 a33 f1 - a23 a32 f1
        ! x1 = ---------------------------------------------------------------------------------
        !      a11 a22 a33 - a11 a23 a32 - a12 a21 a33 + a12 a23 a31 + a13 a21 a32 - a13 a22 a31


        res1(it) = &
             a(1,2) * a(2,3) * f(3) - &
             a(1,2) * a(3,3) * f(2) - &
             a(1,3) * a(2,2) * f(3) + &
             a(1,3) * a(3,2) * f(2) + &
             a(2,2) * a(3,3) * f(1) - &
             a(2,3) * a(3,2) * f(1)


        res1(it) = res1(it) / denom

     END DO

  ELSE   


     a(1,1) = r0 
     a(1,2) = -r1(1)
     a(1,3) = -r1(2)  
     a(1,4) = -r1(3) 
     a(2,1) = r1(1) 
     a(2,2) = -r2(1,1)
     a(2,3) = -r2(2,1)  
     a(2,4) = -r2(3,1)
     a(3,1) = r1(2) 
     a(3,2) = -r2(1,2)
     a(3,3) = -r2(2,2) 
     a(3,4) = -r2(3,2)  
     a(4,1) = r1(3) 
     a(4,2) = -r2(1,3)
     a(4,3) = -r2(2,3) 
     a(4,4) = -r2(3,3)


     denom = &
          a(1,1) * a(2,2) * a(3,3) * a(4,4) - a(1,1) * a(2,2) * a(3,4) * a(4,3) - &
          a(1,1) * a(2,3) * a(3,2) * a(4,4) + a(1,1) * a(2,3) * a(3,4) * a(4,2) + & 
          a(1,1) * a(2,4) * a(3,2) * a(4,3) - a(1,1) * a(2,4) * a(3,3) * a(4,2) - &
          a(1,2) * a(2,1) * a(3,3) * a(4,4) + a(1,2) * a(2,1) * a(3,4) * a(4,3) + &
          a(1,2) * a(2,3) * a(3,1) * a(4,4) - a(1,2) * a(2,3) * a(3,4) * a(4,1) - &
          a(1,2) * a(2,4) * a(3,1) * a(4,3) + a(1,2) * a(2,4) * a(3,3) * a(4,1) + &
          a(1,3) * a(2,1) * a(3,2) * a(4,4) - a(1,3) * a(2,1) * a(3,4) * a(4,2) - &
          a(1,3) * a(2,2) * a(3,1) * a(4,4) + a(1,3) * a(2,2) * a(3,4) * a(4,1) + &
          a(1,3) * a(2,4) * a(3,1) * a(4,2) - a(1,3) * a(2,4) * a(3,2) * a(4,1) - &
          a(1,4) * a(2,1) * a(3,2) * a(4,3) + a(1,4) * a(2,1) * a(3,3) * a(4,2) + &
          a(1,4) * a(2,2) * a(3,1) * a(4,3) - a(1,4) * a(2,2) * a(3,3) * a(4,1) - &
          a(1,4) * a(2,3) * a(3,1) * a(4,2) + a(1,4) * a(2,3) * a(3,2) * a(4,1)
          



     DO it = 1, num_dim

        f(1) = f0(it)
        f(2) = f1(it, 1)
        f(3) = f1(it, 2)  
        f(4) = f1(it, 3)


        ! solves to find the first unknown of a system of linear equations of size 4.

        ! [aij] * [xj] = [fi]

        !     -( a12 a23 a34 f4 - a12 a23 a44 f3 - a12 a24 a33 f4 + a12 a24 a43 f3 + a12 a33 a44 f2 -
        !        a12 a34 a43 f2 - a13 a22 a34 f4 + a13 a22 a44 f3 + a13 a24 a32 f4 - a13 a24 a42 f3 -
        !        a13 a32 a44 f2 + a13 a34 a42 f2 + a14 a22 a33 f4 - a14 a22 a43 f3 - a14 a23 a32 f4 +
        !        a14 a23 a42 f3 + a14 a32 a43 f2 - a14 a33 a42 f2 - a22 a33 a44 f1 + a22 a34 a43 f1 +
        !        a23 a32 a44 f1 - a23 a34 a42 f1 - a24 a32 a43 f1 + a24 a33 a42 f1 )
        ! x1 = ----------------------------------------------------------------------------------------
        !            ( a11 a22 a33 a44 - a11 a22 a34 a43 - a11 a23 a32 a44 + a11 a23 a34 a42 + 
        !              a11 a24 a32 a43 - a11 a24 a33 a42 - a12 a21 a33 a44 + a12 a21 a34 a43 + 
        !              a12 a23 a31 a44 - a12 a23 a34 a41 - a12 a24 a31 a43 + a12 a24 a33 a41 + 
        !              a13 a21 a32 a44 - a13 a21 a34 a42 - a13 a22 a31 a44 + a13 a22 a34 a41 + 
        !              a13 a24 a31 a42 - a13 a24 a32 a41 - a14 a21 a32 a43 + a14 a21 a33 a42 + 
        !              a14 a22 a31 a43 - a14 a22 a33 a41 - a14 a23 a31 a42 + a14 a23 a32 a41 )


        res1(it) = -( &
             a(1,2) * a(2,3) * a(3,4) * f(4) - a(1,2) * a(2,3) * a(4,4) * f(3) - &
             a(1,2) * a(2,4) * a(3,3) * f(4) + a(1,2) * a(2,4) * a(4,3) * f(3) + &
             a(1,2) * a(3,3) * a(4,4) * f(2) - a(1,2) * a(3,4) * a(4,3) * f(2) - &
             a(1,3) * a(2,2) * a(3,4) * f(4) + a(1,3) * a(2,2) * a(4,4) * f(3) + &
             a(1,3) * a(2,4) * a(3,2) * f(4) - a(1,3) * a(2,4) * a(4,2) * f(3) - &
             a(1,3) * a(3,2) * a(4,4) * f(2) + a(1,3) * a(3,4) * a(4,2) * f(2) + &
             a(1,4) * a(2,2) * a(3,3) * f(4) - a(1,4) * a(2,2) * a(4,3) * f(3) - &
             a(1,4) * a(2,3) * a(3,2) * f(4) + a(1,4) * a(2,3) * a(4,2) * f(3) + &
             a(1,4) * a(3,2) * a(4,3) * f(2) - a(1,4) * a(3,3) * a(4,2) * f(2) - &
             a(2,2) * a(3,3) * a(4,4) * f(1) + a(2,2) * a(3,4) * a(4,3) * f(1) + &
             a(2,3) * a(3,2) * a(4,4) * f(1) - a(2,3) * a(3,4) * a(4,2) * f(1) - &
             a(2,4) * a(3,2) * a(4,3) * f(1) + a(2,4) * a(3,3) * a(4,2) * f(1))


        res1(it) = res1(it) / denom


     END DO


  END IF
